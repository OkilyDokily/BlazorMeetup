@page "/"
@using System.Security.Claims;
@using System.Diagnostics
@using Microsoft.AspNetCore.Identity;
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<Attendee> UserManager
@inject RoleManager<IdentityRole> RoleManager
@inject MeetupService MeetupService

<h1>Hello, world!</h1>


Welcome to your new app.
<AuthorizeView>
    <Authorized>
        @if(DbUser != null)
        { 
        <style>
    #divimg {
        background: url(@DbUser.AvatarSettings.AvatarUrl);
        width: 30px;
        height: 30px;
        border-radius: 50%;
        border: 1px black solid;
        background-repeat: no-repeat;
        background-color: #1fe0;
        background-size: @(DbUser.AvatarSettings.Size + "%");
        background-position: @(DbUser.AvatarSettings.Left + "%") @(DbUser.AvatarSettings.Top + "%");
    }
        </style>
    }
        <a href="#">Hello, @context.User.Identity.Name!</a>
        <p></p>
        <a href="Identity/Account/Logout">Log out</a>
        <div id="divimg" >

        </div>

      
    </Authorized>
    <NotAuthorized>
        <a href="Identity/Account/Login">Log in</a>
    </NotAuthorized>
    <Authorized>
        <a href="#">Hello, @context.User.Identity.Name!</a>
        <p></p>
        <a href="Identity/Account/Logout">Log out</a>

    </Authorized>
</AuthorizeView>


@code {

    string avatar;
    ClaimsPrincipal User { get; set; }
    List<Claim> Claims { get; set; }
    Attendee DbUser { get; set; }
    protected async override Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        User = authState.User;

        if (User.Identity.IsAuthenticated)
        {

            DbUser = await UserManager.GetUserAsync(User);
            if(DbUser != null && DbUser.AvatarSettings == null)
            {
                if (User.FindFirstValue("urn:discord:avatar:url") != null)
                {
                    string userURL = User.FindFirstValue("urn:discord:avatar:url");
                    MeetupService.AddAvatarSettings(new AvatarSettings { AttendeeId = DbUser.Id, AvatarUrl = userURL, Left = 0, Top = 0, Size = 100 });
                }
                else
                {
                    string userURL = User.FindFirstValue("urn:discord:avatar:url");
                    MeetupService.AddAvatarSettings(new AvatarSettings { AttendeeId = DbUser.Id, AvatarUrl = "/avatars/blank-profile.webp", Left = 0, Top = 0, Size = 100 });
                }
            }


        }

    }
}
